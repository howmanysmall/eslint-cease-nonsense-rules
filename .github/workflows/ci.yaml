name: ci

on:
  push:
    branches:
      - main
    paths:
      - "src/**/*.ts"
      - "tests/**/*.ts"
      - "package.json"
      - "bun.lock"
      - "knip.ts"
      - "tsconfig*.json"
      - ".oxlintrc.json"
      - "biome.jsonc"
  pull_request:
    paths:
      - "src/**/*.ts"
      - "tests/**/*.ts"
      - "package.json"
      - "bun.lock"
      - "knip.ts"
      - "tsconfig*.json"
      - ".oxlintrc.json"
      - "biome.jsonc"

env:
  TEST_SHARDS: 8
  HEAVY_TEST_SHARDS: 4

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install
        run: |
          bun ci
          bun ci --cwd documentation

      - name: Biome CI
        run: bun run biome:ci

      - name: Setup oxlint-tsgolint
        run: bun add -D oxlint-tsgolint@latest

      - name: Lint
        run: bun run oxc .

      - name: Type Checking
        run: bun run type-check

      - name: Knip
        run: bun run knip

      - name: Build
        run: bun run build

  test:
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install
        run: bun ci

      - name: Get shard test files
        id: shard
        run: |
          ALL_FILES=$(bun ./scripts/shard-tests.ts ${{ matrix.shard }} ${{ env.TEST_SHARDS }})
          # Exclude heavy test files (handled by test-heavy job)
          SHARD_FILES=$(echo "$ALL_FILES" | tr ' ' '\n' | grep -v -E '(prevent-abbreviations|naming-convention\.test)' | tr '\n' ' ')
          echo "files=$SHARD_FILES" >> $GITHUB_OUTPUT
          echo "Shard ${{ matrix.shard }}/${{ env.TEST_SHARDS }} files: $SHARD_FILES"

      - name: Run tests for shard
        if: steps.shard.outputs.files != ''
        env:
          AGENT: 1
        run: |
          bun test --bail ${{ steps.shard.outputs.files }}

  test-heavy:
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        file:
          - tests/upstream/prevent-abbreviations.test.ts
          - tests/upstream/naming-convention.test.ts
        case_shard: [1, 2, 3, 4]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install
        run: bun ci

      - name: Run heavy test file with case sharding
        env:
          AGENT: 1
          TEST_CASE_SHARD: ${{ matrix.case_shard }}/${{ env.HEAVY_TEST_SHARDS }}
        run: |
          echo "Running ${{ matrix.file }} with case shard ${{ matrix.case_shard }}/${{ env.HEAVY_TEST_SHARDS }}"
          bun test --bail ${{ matrix.file }}

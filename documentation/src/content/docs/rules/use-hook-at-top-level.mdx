---
title: use-hook-at-top-level
---

import { Code } from "@astrojs/starlight/components";

Enforces that React hooks are only called at the top level of components or custom hooks, never conditionally or in nested functions.

## Rule Details

React's Rules of Hooks require that hooks are called:

1. At the top level (not in loops, conditions, or nested functions)
2. In the same order every render
3. Only in React function components or custom hooks

**External Documentation**: [React Rules of Hooks](https://react.dev/reference/rules/rules-of-hooks)

## Options

<Code
	code={[
		"{",
		'\t"cease-nonsense/use-hook-at-top-level": [',
		'\t\t"error",',
		"\t\t{",
		"\t\t\t// Strategy 1: Ignore specific hooks by name",
		'\t\t\t"ignoreHooks": ["useEntity", "useComponent"],',
		"",
		"\t\t\t// Strategy 2: Control by import source",
		'\t\t\t"importSources": {',
		'\t\t\t\t"react": true, // Check hooks from React',
		'\t\t\t\t"my-ecs-library": false, // Ignore ECS hooks',
		"\t\t\t},",
		"",
		"\t\t\t// Strategy 3: Whitelist mode (only check these)",
		'\t\t\t"onlyHooks": ["useState", "useEffect", "useContext"],',
		"\t\t},",
		"\t],",
		"}",
	].join("\n")}
	lang="typescript"
	key="block-0-cwkgz7"
/>

### Configuration Parameters

- **ignoreHooks** (default: `[]`): Array of hook names to ignore
- **importSources** (default: `{}`): Object mapping import sources to boolean (check or ignore)
- **onlyHooks** (default: `[]`): Whitelist of hooks to check (ignores all others)

## Examples

### ❌ Incorrect

<Code
	code={[
		"function UserProfile({ userId }) {",
		"\t// Conditional hook call",
		"\tif (userId) {",
		"\t\tuseEffect(() => {",
		"\t\t\tfetchUser(userId);",
		"\t\t}, [userId]); // ERROR: hook in conditional",
		"\t}",
		"",
		"\t// Hook in loop",
		"\tfor (const id of ids) {",
		"\t\tconst user = useUser(id); // ERROR: hook in loop",
		"\t}",
		"",
		"\t// Hook in nested function",
		"\tfunction handleClick() {",
		"\t\tconst [clicked, setClicked] = useState(false); // ERROR: hook in nested function",
		"\t}",
		"",
		"\t// Hook in callback",
		"\tuseEffect(() => {",
		"\t\tconst [data, setData] = useState(null); // ERROR: hook in callback",
		"\t}, []);",
		"",
		"\t// Early return before hook",
		"\tif (!userId) return null;",
		"\tconst user = useUser(userId); // ERROR: hook after conditional return",
		"",
		"\treturn <div>{user.name}</div>;",
		"}",
	].join("\n")}
	lang="typescript"
	key="function-userprofile-12se9x"
/>

### ✅ Correct

<Code
	code={[
		"function UserProfile({ userId }) {",
		"\t// Hooks at top level",
		"\tconst user = useUser(userId);",
		"\tconst [isOpen, setIsOpen] = useState(false);",
		"",
		"\tuseEffect(() => {",
		"\t\t// Condition inside hook (not around it)",
		"\t\tif (userId) {",
		"\t\t\tfetchUser(userId);",
		"\t\t}",
		"\t}, [userId]);",
		"",
		"\t// Hook before early return",
		"\tif (!user) return null;",
		"",
		"\treturn <div>{user.name}</div>;",
		"}",
		"",
		"// Nested function without hooks is fine",
		"function Component() {",
		"\tconst [count, setCount] = useState(0);",
		"",
		"\tfunction handleClick() {",
		"\t\tsetCount((c) => c + 1); // Using setState (not calling hook)",
		"\t}",
		"",
		"\treturn <button onClick={handleClick}>{count}</button>;",
		"}",
	].join("\n")}
	lang="typescript"
	key="function-userprofile-10d26o"
/>

## Why This Rule Exists

### Order Consistency

React relies on hook call order to maintain state:

<Code
	code={[
		"function Component({ condition }) {",
		"\t// Render 1: useState called first",
		"\tconst [a, setA] = useState(1);",
		"",
		"\tif (condition) {",
		"\t\t// Render 2: this hook might not be called",
		"\t\tconst [b, setB] = useState(2); // Hook order changes!",
		"\t}",
		"",
		"\t// React's internal state array gets misaligned",
		"}",
	].join("\n")}
	lang="typescript"
	key="function-component-c-c1yz71"
/>

### State Corruption

Inconsistent hook calls corrupt React's internal state:

<Code
	code={[
		"// First render (condition = true)",
		"// React's state: [stateA, stateB, stateC]",
		"",
		"// Second render (condition = false)",
		"// React's state: [stateA, stateC] // stateB skipped!",
		"// React thinks stateC is stateB → corruption",
	].join("\n")}
	lang="typescript"
	key="first-render-conditi-38w5px"
/>

### Correct Patterns

<Code
	code={[
		"function Component({ condition }) {",
		"\t// ✅ Always call hooks",
		"\tconst [a, setA] = useState(1);",
		"\tconst [b, setB] = useState(2);",
		"",
		"\t// Put condition logic inside hook effects",
		"\tuseEffect(() => {",
		"\t\tif (condition) {",
		"\t\t\t// Conditional logic here",
		"\t\t}",
		"\t}, [condition]);",
		"",
		"\treturn <div />;",
		"}",
	].join("\n")}
	lang="typescript"
	key="function-component-c-1rbmes"
/>

## Common Mistakes

### Conditional Mounting

<Code
	code={[
		"// ❌ Wrong: conditional hook",
		"function Component({ showFeature }) {",
		"\tif (showFeature) {",
		"\t\tconst feature = useFeature(); // ERROR",
		"\t}",
		"}",
		"",
		"// ✅ Right: always call hook, use conditionally",
		"function Component({ showFeature }) {",
		"\tconst feature = useFeature();",
		"",
		"\tif (!showFeature) return null;",
		"",
		"\treturn <div>{feature.name}</div>;",
		"}",
	].join("\n")}
	lang="typescript"
	key="wrong-conditional-ho-1yr3bs"
/>

### Loops

<Code
	code={[
		"// ❌ Wrong: hook in loop",
		"function UserList({ userIds }) {",
		"\treturn userIds.map((id) => {",
		"\t\tconst user = useUser(id); // ERROR",
		"\t\treturn <div>{user.name}</div>;",
		"\t});",
		"}",
		"",
		"// ✅ Right: extract component",
		"function UserItem({ userId }) {",
		"\tconst user = useUser(userId); // Hook at top level",
		"\treturn <div>{user.name}</div>;",
		"}",
		"",
		"function UserList({ userIds }) {",
		"\treturn userIds.map((id) => <UserItem key={id} userId={id} />);",
		"}",
	].join("\n")}
	lang="typescript"
	key="wrong-hook-in-loop-of5ezr"
/>

### Early Returns

<Code
	code={[
		"// ❌ Wrong: hook after conditional return",
		"function Component({ data }) {",
		"\tif (!data) return null; // Early return",
		"\tconst processed = useProcessData(data); // ERROR: might not be called",
		"\treturn <div>{processed}</div>;",
		"}",
		"",
		"// ✅ Right: hook before conditional return",
		"function Component({ data }) {",
		"\tconst processed = useProcessData(data); // Always called",
		"\tif (!processed) return null;",
		"\treturn <div>{processed}</div>;",
		"}",
	].join("\n")}
	lang="typescript"
	key="wrong-hook-after-con-3cxyge"
/>

## Custom Hooks

Custom hooks must also follow these rules:

<Code
	code={[
		"// ✅ Correct custom hook",
		"function useUserData(userId: string) {",
		"\tconst [user, setUser] = useState(null);",
		"",
		"\tuseEffect(() => {",
		"\t\tif (userId) {",
		"\t\t\tfetchUser(userId).then(setUser);",
		"\t\t}",
		"\t}, [userId]);",
		"",
		"\treturn user;",
		"}",
		"",
		"// ❌ Wrong: conditional hook in custom hook",
		"function useBadHook(condition: boolean) {",
		"\tif (condition) {",
		"\t\tconst [state, setState] = useState(0); // ERROR",
		"\t}",
		"}",
	].join("\n")}
	lang="typescript"
	key="correct-custom-hook-e2s17c"
/>

## Ignoring Non-React Hooks

Some libraries use `use` prefix but aren't React hooks:

<Code
	code={[
		"{",
		'  "ignoreHooks": ["useEntity", "useComponent"],  // ECS library hooks',
		'  "importSources": {',
		'    "react": true,',
		'    "@rbxts/react-reflex": true,',
		'    "my-ecs-lib": false  // Not React hooks',
		"  }",
		"}",
	].join("\n")}
	lang="typescript"
	key="block-10-1zmgzn"
/>

<Code
	code={[
		"// Ignored (ECS library, not React)",
		"function System() {",
		"\tfor (const entity of entities) {",
		"\t\tconst component = useComponent(entity); // OK (ignored)",
		"\t}",
		"}",
	].join("\n")}
	lang="typescript"
	key="ignored-ecs-library--2db332"
/>

## Exception: Test Utilities

Test utilities that use `use` prefix aren't subject to this rule:

<Code
	code={[
		"// In tests, this is fine",
		'test("my test", () => {',
		"\tif (condition) {",
		"\t\tconst result = useTestHelper(); // Test utility, not React hook",
		"\t}",
		"});",
	].join("\n")}
	lang="typescript"
	key="in-tests-this-is-fin-2igda3"
/>

## When Not To Use It

If you're not using React or are using a library with `use`-prefixed functions that aren't React hooks, configure the rule to ignore those patterns or disable it entirely.

## Related Rules

- [use-exhaustive-dependencies](./use-exhaustive-dependencies.md) - Ensures correct dependency arrays
- [require-named-effect-functions](./require-named-effect-functions.md) - Enforces named effect callbacks

## Further Reading

- [React Rules of Hooks](https://react.dev/reference/rules/rules-of-hooks)
- [ESLint Plugin React Hooks](https://www.npmjs.com/package/eslint-plugin-react-hooks)
- [Why Hooks Order Matters](https://react.dev/warnings/invalid-hook-call-warning)
